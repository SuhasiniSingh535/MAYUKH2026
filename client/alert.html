<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alert Manager | Mayukh Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { background-color: #02040a; color: white; font-family: 'Rajdhani', sans-serif; }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">


    <script>
        (function checkAuth() {
            const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 Minutes (in milliseconds)
            const lastLogin = localStorage.getItem("admin_login_time");
            const currentTime = new Date().getTime();

            // 1. Check if user is logged in AND session is valid
            if (localStorage.getItem("admin_logged_in") === "true" && lastLogin) {
                
                // Check if time expired
                if (currentTime - lastLogin > SESSION_TIMEOUT) {
                    alert("‚è≥ Session Expired. Please login again.");
                    logout();
                    return;
                } else {
                    // User is active, EXTEND the session time
                    localStorage.setItem("admin_login_time", currentTime);
                    return; // Access Granted
                }
            }

            // // 2. If not logged in, Ask for Password
            // const pass = prompt("üîí ADMIN ACCESS REQUIRED:\nEnter Password:");
            // if (pass === "Mayukh@2026") {
            //     localStorage.setItem("admin_logged_in", "true");
            //     localStorage.setItem("admin_login_time", new Date().getTime()); // Set Start Time
            // } else {
            //     alert("‚ùå Access Denied!");
            //     window.location.href = "index.html"; 
            // }

            function logout() {
                localStorage.removeItem("admin_logged_in");
                localStorage.removeItem("admin_login_time");
                window.location.href = "index.html";
            }
        })();
    </script>

    <div class="bg-gray-900 border-b border-gray-800 p-4 flex justify-between items-center shadow-lg z-20">
        <div class="flex items-center gap-4">
            <div class="absolute top-5 right-6 z-50 flex gap-3">
            <a href="media.html" class="bg-gray-800 border border-gray-700 text-[10px] text-purple-400 px-4 py-2 rounded-full hover:bg-purple-600 hover:text-white transition-all shadow-lg flex items-center gap-2">
                <i class="fa-solid fa-images"></i> MEDIA
            </a>
            
            <a href="admin.html" class="bg-gray-800 border border-gray-700 text-[10px] text-red-400 px-4 py-2 rounded-full hover:bg-red-600 hover:text-white transition-all shadow-lg flex items-center gap-2">
                <i class="fa-solid fa-bell"></i> EVENTS
            </a>

            <a href="index.html" onclick="localStorage.removeItem('admin_logged_in'); localStorage.removeItem('admin_login_time');" class="bg-red-900/80 border border-red-700 text-[10px] text-white px-4 py-2 rounded-full hover:bg-red-600 transition-all shadow-lg flex items-center gap-2">
                <i class="fa-solid fa-power-off"></i> LOGOUT
            </a>
        </div>
            <h1 class="text-xl font-bold tracking-wider text-red-500 orbitron">EMERGENCY ALERT SYSTEM</h1>
        </div>
        <div class="text-xs text-gray-500 font-mono">ADMIN MODE</div>
    </div>

    <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <div class="w-full md:w-1/3 bg-gray-900/50 p-6 border-r border-gray-800 overflow-y-auto backdrop-blur-sm">
            <h2 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                <i class="fa-solid fa-pen-to-square text-red-500"></i> <span id="formTitle">CREATE NEW ALERT</span>
            </h2>

            <form id="alertForm" class="space-y-4">
                <input type="hidden" id="editAlertId">

                <div>
                    <label class="text-[10px] text-gray-400 font-bold tracking-wider">TARGET EVENT</label>
                    <select id="alertEventSelect" class="w-full bg-gray-800 p-3 rounded text-sm text-white border border-gray-700 focus:border-red-500 outline-none transition">
                        <option value="">-- Loading Events --</option>
                    </select>
                </div>

                <div class="p-4 bg-black/40 rounded-lg border border-gray-800 space-y-3">
                    <p class="text-[10px] text-red-400 font-bold mb-1 uppercase tracking-widest">Update Details (Optional)</p>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="changeVenue" placeholder="New Venue" class="bg-gray-800 p-2 rounded text-xs text-white border border-gray-700 focus:border-red-500 outline-none">
                        <input type="text" id="changeTime" placeholder="New Time" class="bg-gray-800 p-2 rounded text-xs text-white border border-gray-700 focus:border-red-500 outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="changeDate" placeholder="New Date" class="bg-gray-800 p-2 rounded text-xs text-white border border-gray-700 focus:border-red-500 outline-none">
                        <input type="text" id="changeFees" placeholder="New Fee" class="bg-gray-800 p-2 rounded text-xs text-white border border-gray-700 focus:border-red-500 outline-none">
                    </div>
                    <textarea id="changeNote" rows="3" placeholder="Important Note (e.g. 'Event Cancelled due to rain')" class="w-full bg-gray-800 p-2 rounded text-xs text-white border border-gray-700 focus:border-red-500 outline-none"></textarea>
                </div>

                <button type="button" onclick="submitAlert()" id="submitBtn" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded shadow-[0_0_15px_rgba(239,68,68,0.4)] transition-all tracking-widest text-sm">
                    PUBLISH ALERT
                </button>
                
                <button type="button" onclick="resetForm()" id="cancelBtn" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold py-2 rounded text-xs hidden">
                    CANCEL EDIT
                </button>
            </form>
        </div>

        <div class="w-full md:w-2/3 bg-black p-6 overflow-y-auto relative">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20 pointer-events-none"></div>
            
            <h2 class="text-2xl font-bold text-white mb-6 orbitron flex justify-between items-center">
                ACTIVE BROADCASTS
                <span id="alertCount" class="text-xs bg-red-900 text-red-200 px-2 py-1 rounded font-mono">0</span>
            </h2>
            
            <div id="alertsList" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <p class="text-gray-600 text-sm animate-pulse">Scanning frequency...</p>
            </div>
        </div>
    </div>

    <script src="api-config.js"></script> 
    
    <script>
        // ‚úÖ CORRECT API CONNECTION LOGIC
        const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:5001/api'
            : 'https://mayukh-bv-1.onrender.com/api'; // Ensure this matches your live backend URL

        // --- 1. Load Data on Start ---
        window.onload = async () => {
            await loadEvents();
            await loadAlerts();
        };

        // --- 2. Load Events for Dropdown ---
        async function loadEvents() {
            try {
                // Adjust endpoint if your event API is different
                const res = await fetch(`${API_BASE}/events`); 
                const data = await res.json();
                const select = document.getElementById('alertEventSelect');
                
                // Handle different API response structures ({events: []} vs [])
                const events = data.events || data; 
                
                select.innerHTML = '<option value="">-- Select Target Event --</option>';
                events.forEach(e => {
                    select.innerHTML += `<option value="${e.title}">${e.title}</option>`;
                });
            } catch(e) { console.error("Event Load Error:", e); }
        }

        // --- 3. Submit Logic (Create & Edit) ---
        async function submitAlert() {
            const eventName = document.getElementById('alertEventSelect').value;
            const editId = document.getElementById('editAlertId').value;
            
            if(!eventName) return alert("Please select an event target!");

            const body = {
                eventName: eventName,
                venue: document.getElementById('changeVenue').value,
                time: document.getElementById('changeTime').value,
                date: document.getElementById('changeDate').value,
                fees: document.getElementById('changeFees').value,
                note: document.getElementById('changeNote').value
            };

            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;
            btn.innerText = "TRANSMITTING...";
            btn.disabled = true;

            try {
                let url = `${API_BASE}/event-alerts`;
                let method = 'POST';

                if(editId) {
                    url = `${API_BASE}/event-alerts/${editId}`;
                    method = 'PUT';
                }

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if(res.ok) {
                    resetForm();
                    loadAlerts();
                } else {
                    alert("Transmission Failed.");
                }
            } catch(e) { 
                console.error(e); 
                alert("Server Error");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // --- 4. Load & Display Alerts ---
        async function loadAlerts() {
            try {
                const res = await fetch(`${API_BASE}/event-alerts`);
                const alerts = await res.json();
                
                document.getElementById('alertCount').innerText = alerts.length;
                const container = document.getElementById('alertsList');
                
                if(alerts.length === 0) {
                    container.innerHTML = `<div class="col-span-full text-center text-gray-600 py-10 border border-gray-800 rounded border-dashed">No Active Alerts</div>`;
                    return;
                }

                container.innerHTML = alerts.map(a => `
                    <div class="bg-gray-900 border border-gray-700 hover:border-red-500/50 p-4 rounded-xl relative group transition-all">
                        <div class="absolute top-4 right-4 flex gap-2 opacity-50 group-hover:opacity-100 transition">
                            <button onclick="editAlert('${encodeURIComponent(JSON.stringify(a))}')" class="text-yellow-500 hover:text-white"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteAlert('${a._id}')" class="text-red-500 hover:text-white"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        
                        <h3 class="font-bold text-white text-lg orbitron mb-2 text-red-400">${a.eventName}</h3>
                        
                        <div class="space-y-1 text-xs font-mono text-gray-400 bg-black/30 p-3 rounded">
                            ${a.changes.venue ? `<div class="flex justify-between border-b border-gray-800 pb-1"><span>VENUE CHANGE</span><span class="text-white">${a.changes.venue}</span></div>` : ''}
                            ${a.changes.time ? `<div class="flex justify-between border-b border-gray-800 pb-1"><span>TIME CHANGE</span><span class="text-white">${a.changes.time}</span></div>` : ''}
                            ${a.changes.date ? `<div class="flex justify-between border-b border-gray-800 pb-1"><span>DATE CHANGE</span><span class="text-white">${a.changes.date}</span></div>` : ''}
                            ${a.changes.fees ? `<div class="flex justify-between border-b border-gray-800 pb-1"><span>FEE UPDATE</span><span class="text-white">${a.changes.fees}</span></div>` : ''}
                            ${a.changes.note ? `<div class="mt-2 text-yellow-500 italic">"${a.changes.note}"</div>` : ''}
                            
                            ${!a.changes.venue && !a.changes.time && !a.changes.date && !a.changes.fees && !a.changes.note ? '<span class="text-gray-600 italic">No specific details provided.</span>' : ''}
                        </div>
                        <div class="mt-2 text-[10px] text-gray-600 text-right">ID: ${a._id.slice(-6)}</div>
                    </div>
                `).join('');
            } catch(e) { console.error(e); }
        }

        // --- 5. Helper Functions ---
        async function deleteAlert(id) {
            if(!confirm("Terminate this broadcast?")) return;
            await fetch(`${API_BASE}/event-alerts/${id}`, { method: 'DELETE' });
            loadAlerts();
        }

        function editAlert(strData) {
            const data = JSON.parse(decodeURIComponent(strData));
            
            document.getElementById('editAlertId').value = data._id;
            document.getElementById('alertEventSelect').value = data.eventName;
            document.getElementById('changeVenue').value = data.changes.venue || '';
            document.getElementById('changeTime').value = data.changes.time || '';
            document.getElementById('changeDate').value = data.changes.date || '';
            document.getElementById('changeFees').value = data.changes.fees || '';
            document.getElementById('changeNote').value = data.changes.note || '';

            document.getElementById('formTitle').innerText = "EDITING BROADCAST";
            document.getElementById('submitBtn').innerText = "UPDATE ALERT";
            document.getElementById('submitBtn').className = "w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded shadow transition-all tracking-widest text-sm";
            document.getElementById('cancelBtn').classList.remove('hidden');
        }

        function resetForm() {
            document.getElementById('alertForm').reset();
            document.getElementById('editAlertId').value = '';
            
            document.getElementById('formTitle').innerText = "CREATE NEW ALERT";
            document.getElementById('submitBtn').innerText = "PUBLISH ALERT";
            document.getElementById('submitBtn').className = "w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded shadow-[0_0_15px_rgba(239,68,68,0.4)] transition-all tracking-widest text-sm";
            document.getElementById('cancelBtn').classList.add('hidden');
        }
    </script>
</body>
</html>