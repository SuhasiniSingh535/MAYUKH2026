<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mayukh Media Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        .hidden-tab { display: none; }
        .active-tab { border-bottom: 2px solid #06b6d4; color: #06b6d4; }
        .inactive-tab { color: #9ca3af; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col overflow-hidden font-sans">

    <script>
        (function checkAuth() {
            const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 Minutes (in milliseconds)
            const lastLogin = localStorage.getItem("admin_login_time");
            const currentTime = new Date().getTime();

            // 1. Check if user is logged in AND session is valid
            if (localStorage.getItem("admin_logged_in") === "true" && lastLogin) {
                
                // Check if time expired
                if (currentTime - lastLogin > SESSION_TIMEOUT) {
                    alert("‚è≥ Session Expired. Please login again.");
                    logout();
                    return;
                } else {
                    // User is active, EXTEND the session time
                    localStorage.setItem("admin_login_time", currentTime);
                    return; // Access Granted
                }
            }

            // // 2. If not logged in, Ask for Password
            // const pass = prompt("üîí ADMIN ACCESS REQUIRED:\nEnter Password:");
            // if (pass === "Mayukh@2026") {
            //     localStorage.setItem("admin_logged_in", "true");
            //     localStorage.setItem("admin_login_time", new Date().getTime()); // Set Start Time
            // } else {
            //     alert("‚ùå Access Denied!");
            //     window.location.href = "index.html"; 
            // }

            function logout() {
                localStorage.removeItem("admin_logged_in");
                localStorage.removeItem("admin_login_time");
                window.location.href = "index.html";
            }
        })();
    </script>

    <div class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center shadow-lg z-20">
        <div class="flex items-center gap-4">
            <div class="absolute top-5 right-6 z-50 flex gap-3">
            <a href="admin.html" class="bg-gray-800 border border-gray-700 text-[10px] text-purple-400 px-4 py-2 rounded-full hover:bg-purple-600 hover:text-white transition-all shadow-lg flex items-center gap-2">
                <i class="fa-solid fa-images"></i> EVENTS
            </a>
            
            <a href="alert.html" class="bg-gray-800 border border-gray-700 text-[10px] text-red-400 px-4 py-2 rounded-full hover:bg-red-600 hover:text-white transition-all shadow-lg flex items-center gap-2">
                <i class="fa-solid fa-bell"></i> ALERTS
            </a>

            <a href="index.html" onclick="localStorage.removeItem('admin_logged_in'); localStorage.removeItem('admin_login_time');" class="bg-red-900/80 border border-red-700 text-[10px] text-white px-4 py-2 rounded-full hover:bg-red-600 transition-all shadow-lg flex items-center gap-2">
                <i class="fa-solid fa-power-off"></i> LOGOUT
            </a>
        </div>
            <h1 class="text-xl font-bold tracking-wider text-cyan-400">MEDIA MANAGER</h1>
        </div>
        <div class="flex gap-6 text-sm font-bold">
            <button onclick="switchTab('teams')" id="btn-teams" class="active-tab pb-1 transition-all">TEAMS</button>
            <button onclick="switchTab('gallery')" id="btn-gallery" class="inactive-tab pb-1 transition-all">GALLERY</button>
        </div>
    </div>

    <div class="flex-1 flex overflow-hidden relative">
        
        <div id="tab-teams" class="flex w-full h-full">
            <div class="w-1/3 bg-gray-800 p-6 border-r border-gray-700 overflow-y-auto">
                <h2 class="text-lg font-bold text-cyan-400 mb-4 flex justify-between">
                    <span id="teamFormTitle">ADD TEAM </span>
                    <button onclick="resetTeamForm()" class="text-[10px] bg-gray-700 px-2 py-1 rounded text-white">Reset</button>
                </h2>
                <form id="teamForm" class="space-y-4">
                    <input type="hidden" name="id" id="teamId">
                    <input type="hidden" name="existingImage" id="teamExistingImage">
                    
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold">Caption <span class="text-gray-500">(Optional)</span></label>
                        <input type="text" name="name" placeholder="Ex: TECH CORE " 
                            class="w-full bg-gray-700 p-3 rounded border border-gray-600 text-white focus:border-cyan-500 outline-none">
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold">TEAM</label>
                            <select name="teamName" class="w-full bg-gray-700 p-3 rounded text-xs text-white border border-gray-600">
                                <option value="Technical">Technical</option>
                                <option value="PR">PR</option>
                                <option value="Drama">Drama</option>
                                <option value="Cultural">Cultural</option>
                                <option value="Sponsorship">Sponsorship</option>
                                <option value="Design">Design</option>
                                <option value="Catering">Catering</option>
                                <option value="Workshop">Workshop</option>
                                <option value="Discipline">Discipline</option>
                                <option value="Coverage">Coverage</option>
                                <option value="Web-Dev">Web-Dev</option>
                            </select>
                        </div>
                        <!-- <div>
                            <label class="text-[10px] text-gray-400 font-bold">ROLE</label>
                            <select name="memberType" class="w-full bg-gray-700 p-3 rounded text-xs text-white border border-gray-600">
                                <option value="Core">Core</option>
                                <option value="Sub-Core">Sub-Core</option>
                            </select>
                        </div> -->
                    </div>

    

                    <div>
                        <label class="text-[10px] text-gray-400 font-bold">PHOTO</label>
                        <p class="text-[9px] text-gray-500 mb-1" id="teamImageMsg">Leave empty to keep current photo</p>
                        <input type="file" name="image" class="w-full text-xs text-gray-400 bg-gray-900 rounded p-2">
                    </div>

                    <div id="teamStatus" class="text-center text-xs h-4"></div>
                    <button type="submit" id="teamSubmitBtn" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded transition shadow-lg">
                        SAVE TEAM
                    </button>
                </form>
            </div>

            <div class="w-2/3 bg-black p-6 overflow-y-auto">
                <h2 class="text-2xl font-bold text-white mb-6">Current Team</h2>
                <div id="teamList" class="grid grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <div id="tab-gallery" class="hidden-tab flex w-full h-full">
            <div class="w-1/3 bg-gray-800 p-6 border-r border-gray-700 overflow-y-auto">
                <h2 class="text-lg font-bold text-purple-400 mb-4 flex justify-between">
                    <span id="galleryFormTitle">ADD PHOTO</span>
                    <button onclick="resetGalleryForm()" class="text-[10px] bg-gray-700 px-2 py-1 rounded text-white">Reset</button>
                </h2>
                <form id="galleryForm" class="space-y-4">
                    <input type="hidden" name="id" id="galleryId">
                    <input type="hidden" name="existingImage" id="galleryExistingImage">
                    
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold">CAPTION <span class="text-gray-500">(Optional)</span></label>
                        <input type="text" name="caption" placeholder="Ex: Hackathon Winners" 
                            class="w-full bg-gray-700 p-3 rounded border border-gray-600 text-white focus:border-purple-500 outline-none">
                    </div>

                    <div>
                        <label class="text-[10px] text-gray-400 font-bold">CATEGORY</label>
                        <select name="category" class="w-full bg-gray-700 p-3 rounded text-xs text-white border border-gray-600">
                            <option value="General">General</option>
                            <option value="Cultural Night">Cultural Night</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-[10px] text-gray-400 font-bold">IMAGE</label>
                        <p class="text-[9px] text-gray-500 mb-1" id="galleryImageMsg">Leave empty to keep current photo</p>
                        <input type="file" name="image" class="w-full text-xs text-gray-400 bg-gray-900 rounded p-2">
                    </div>

                    <div id="galleryStatus" class="text-center text-xs h-4"></div>
                    <button type="submit" id="gallerySubmitBtn" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded transition shadow-lg">
                        UPLOAD PHOTO
                    </button>
                </form>
            </div>

            <div class="w-2/3 bg-black p-6 overflow-y-auto">
                <h2 class="text-2xl font-bold text-white mb-6">Gallery Preview</h2>
                
                <h3 class="text-lg font-bold text-purple-400 mb-2 border-b border-gray-700 pb-1">General</h3>
                <div id="galleryListGeneral" class="grid grid-cols-2 lg:grid-cols-3 gap-4 mb-8"></div>

                <h3 class="text-lg font-bold text-pink-400 mb-2 border-b border-gray-700 pb-1">Cultural Night</h3>
                <div id="galleryListCultural" class="grid grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001';
        let allTeamsData = [];
        let allGalleryData = [];

        // --- TAB SWITCHER ---
        function switchTab(tab) {
            document.getElementById('tab-teams').classList.add('hidden-tab');
            document.getElementById('tab-gallery').classList.add('hidden-tab');
            document.getElementById('btn-teams').className = "inactive-tab pb-1 transition-all";
            document.getElementById('btn-gallery').className = "inactive-tab pb-1 transition-all";

            document.getElementById(`tab-${tab}`).classList.remove('hidden-tab');
            document.getElementById(`btn-${tab}`).className = `active-tab pb-1 transition-all text-${tab === 'teams' ? 'cyan' : 'purple'}-400 border-${tab === 'teams' ? 'cyan' : 'purple'}-400`;
            
            if(tab === 'teams') loadTeams();
            else loadGallery();
        }

        // --- TEAMS LOGIC ---
        async function loadTeams() {
            try {
                const res = await fetch(`${API_BASE}/api/teams`);
                allTeamsData = await res.json(); 
                const container = document.getElementById('teamList');
                
                if(allTeamsData.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 col-span-full">No members yet.</p>';
                    return;
                }

                container.innerHTML = allTeamsData.map(m => `
                    <div class="bg-gray-800 p-3 rounded border border-gray-700 flex items-center gap-3 relative group">
                        <img src="${m.imageUrl}" class="w-12 h-12 rounded-full object-cover border border-gray-600">
                        <div class="overflow-hidden">
                            <h4 class="font-bold text-white text-sm truncate">${m.name || 'No Name'}</h4>
                            <p class="text-[10px] text-gray-400">${m.teamName} ‚Ä¢ ${m.memberType}</p>
                        </div>
                        <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="editTeam('${m._id}')" class="text-yellow-500 hover:scale-110"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteItem('teams', '${m._id}')" class="text-red-500 hover:scale-110"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            } catch(e) { console.error(e); }
        }

        // --- EDIT TEAM FUNCTION ---
        function editTeam(id) {
            const member = allTeamsData.find(m => m._id === id);
            if(!member) return;

            document.getElementById('teamId').value = member._id;
            document.getElementById('teamExistingImage').value = member.imageUrl;
            
            document.querySelector('#teamForm [name="name"]').value = member.name || '';
            document.querySelector('#teamForm [name="teamName"]').value = member.teamName;
            //document.querySelector('#teamForm [name="memberType"]').value = member.memberType;
            document.querySelector('#teamForm [name="linkedin"]').value = member.linkedin || '';

            document.getElementById('teamFormTitle').innerText = "EDITING MEMBER";
            const btn = document.getElementById('teamSubmitBtn');
            btn.innerText = "UPDATE TEAM"; // Changed text for update
            btn.classList.remove('bg-cyan-600');
            btn.classList.add('bg-yellow-600');
            
            document.getElementById('teamImageMsg').innerText = "Uploading new photo will replace current one.";
        }

        function resetTeamForm() {
            document.getElementById('teamForm').reset();
            document.getElementById('teamId').value = '';
            document.getElementById('teamExistingImage').value = '';
            document.getElementById('teamFormTitle').innerText = "ADD TEAM MEMBER";
            const btn = document.getElementById('teamSubmitBtn');
            btn.innerText = "SAVE TEAM"; // Revert text
            btn.classList.remove('bg-yellow-600');
            btn.classList.add('bg-cyan-600');
            document.getElementById('teamImageMsg').innerText = "Leave empty to keep current photo";
        }

        document.getElementById('teamForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await handleSubmit(e, 'teams', 'teamStatus', loadTeams, resetTeamForm);
        });

        // --- GALLERY LOGIC ---
        async function loadGallery() {
            try {
                const res = await fetch(`${API_BASE}/api/gallery`);
                allGalleryData = await res.json(); 
                
                const containerGeneral = document.getElementById('galleryListGeneral');
                const containerCultural = document.getElementById('galleryListCultural');

                // Filter Data
                const generalPhotos = allGalleryData.filter(g => g.category === 'General');
                const culturalPhotos = allGalleryData.filter(g => g.category === 'Cultural Night');

                // Render General
                if(generalPhotos.length === 0) containerGeneral.innerHTML = '<p class="text-gray-500 col-span-full text-xs">No photos in General.</p>';
                else containerGeneral.innerHTML = renderGalleryItems(generalPhotos);

                // Render Cultural
                if(culturalPhotos.length === 0) containerCultural.innerHTML = '<p class="text-gray-500 col-span-full text-xs">No photos in Cultural Night.</p>';
                else containerCultural.innerHTML = renderGalleryItems(culturalPhotos);

            } catch(e) { console.error(e); }
        }

        function renderGalleryItems(items) {
            return items.map(g => `
                <div class="relative group rounded overflow-hidden border border-gray-700">
                    <img src="${g.imageUrl}" class="w-full h-32 object-cover">
                    <div class="absolute bottom-0 left-0 right-0 bg-black/80 p-2">
                        <p class="text-[10px] text-white truncate">${g.caption || 'No Caption'}</p>
                        <p class="text-[9px] text-purple-400">${g.category}</p>
                    </div>
                    <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition">
                         <button onclick="editGallery('${g._id}')" class="bg-yellow-600 text-white text-xs px-2 py-1 rounded">Edit</button>
                         <button onclick="deleteItem('gallery', '${g._id}')" class="bg-red-600 text-white text-xs px-2 py-1 rounded">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // --- EDIT GALLERY FUNCTION ---
        function editGallery(id) {
            const photo = allGalleryData.find(g => g._id === id);
            if(!photo) return;

            document.getElementById('galleryId').value = photo._id;
            document.getElementById('galleryExistingImage').value = photo.imageUrl;
            
            document.querySelector('#galleryForm [name="caption"]').value = photo.caption || '';
            document.querySelector('#galleryForm [name="category"]').value = photo.category;

            document.getElementById('galleryFormTitle').innerText = "EDITING PHOTO";
            const btn = document.getElementById('gallerySubmitBtn');
            btn.innerText = "UPDATE PHOTO";
            btn.classList.remove('bg-purple-600');
            btn.classList.add('bg-yellow-600');
            
            document.getElementById('galleryImageMsg').innerText = "Uploading new photo will replace current one.";
        }

        function resetGalleryForm() {
            document.getElementById('galleryForm').reset();
            document.getElementById('galleryId').value = '';
            document.getElementById('galleryExistingImage').value = '';
            document.getElementById('galleryFormTitle').innerText = "ADD PHOTO";
            const btn = document.getElementById('gallerySubmitBtn');
            btn.innerText = "UPLOAD PHOTO";
            btn.classList.remove('bg-yellow-600');
            btn.classList.add('bg-purple-600');
            document.getElementById('galleryImageMsg').innerText = "Leave empty to keep current photo";
        }

        document.getElementById('galleryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await handleSubmit(e, 'gallery', 'galleryStatus', loadGallery, resetGalleryForm);
        });

        // --- SHARED SUBMIT LOGIC ---
        async function handleSubmit(e, type, statusId, reloadFunc, resetFunc) {
            const form = e.target;
            const btn = form.querySelector('button[type="submit"]');
            const status = document.getElementById(statusId);
            const formData = new FormData(form);
            const id = formData.get('id'); 

            btn.disabled = true;
            btn.innerText = "PROCESSING...";
            status.innerText = "Processing...";
            status.className = "text-center text-xs text-yellow-400 animate-pulse";

            try {
                if(!id) formData.delete('id');

                // If editing, delete old entry first (Simple Logic for image replacement)
                if(id) {
                     await fetch(`${API_BASE}/api/${type}/${id}`, { method: 'DELETE' });
                }

                const res = await fetch(`${API_BASE}/api/${type}`, {
                    method: 'POST',
                    body: formData
                });

                if(res.ok) {
                    status.innerText = "SUCCESS!";
                    status.className = "text-center text-xs text-green-400";
                    resetFunc(); 
                    reloadFunc(); 
                    setTimeout(() => status.innerText = "", 3000);
                } else {
                    const err = await res.json();
                    throw new Error(err.message || "Upload Failed");
                }
            } catch(err) {
                console.error(err);
                status.innerText = "ERROR: " + err.message;
                status.className = "text-center text-xs text-red-400";
            } finally {
                btn.disabled = false;
                // Button text reset handled by resetFunc in success, or manually here if failed? 
                // We rely on resetFunc on success. If fail, it stays on processing/update state which is fine.
                if(status.innerText.includes("ERROR")) {
                     btn.innerText = type === 'teams' ? "RETRY SAVE" : "RETRY UPLOAD";
                }
            }
        }

        async function deleteItem(type, id) {
            if(!confirm("Are you sure?")) return;
            await fetch(`${API_BASE}/api/${type}/${id}`, { method: 'DELETE' });
            if(type === 'teams') loadTeams();
            else loadGallery();
        }

        // Init
        loadTeams();
    </script>
</body>
</html>